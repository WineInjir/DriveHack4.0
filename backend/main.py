from sanic import Sanic
from sanic.response import json, file
import aiohttp, pathlib, uuid, traceback, base64, tempfile, os
from gtts import gTTS
from datetime import datetime
from elevenlabs.client import ElevenLabs
from elevenlabs import play
import os

# ==============================
# üîß –ù–ê–°–¢–†–û–ô–ö–ò
# ==============================
CLIENT_ID = "0199e745-9630-7908-af85-10afefaba1f9"
CLIENT_SECRET = "08a0b6ae-0d81-4829-b6ec-0ca91aa08553"

OAUTH_URL = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth"
CHAT_URL = "https://gigachat.devices.sberbank.ru/api/v1/chat/completions"

client = ElevenLabs(
    api_key="sk_d060ec248d42109e512328ec6be6f15fad405879a419f407"
)

SYSTEM_PROMPT = (
    """
    –¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –º–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω–∞ üöá. "
    –û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –≤–µ–∂–ª–∏–≤–æ –∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ–º–æ–≥–∞–π –ø—Ä–æ–∫–ª–∞–¥—ã–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.
    –û—Ç–≤–µ—á–∞–π –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –Ω–∏–∫–∞–∫–∏—Ö –æ–±—å—è—Å–Ω–µ–Ω–∏–π –≤ —Å–∫–æ–±–æ—á–∫–∞—Ö –∏ –ø–æ—Å—Ç —Å–∫—Ä–∏–ø—Ç—É–º–æ–≤, —Ç—ã –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –∫–∞–∫ –≤ –¥–∏–∞–ª–æ–≥–µ, –∫–æ—Ä–æ—Ç–∫–æ –∏ —Ç–æ–ª—å–∫–æ —Ä–æ –¥–µ–ª—É, –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –±–µ–∑ –Ω–∏–∫–∞–∫–æ–π –ª–∏—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    –¢—ã –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å –º–æ—Å–∫–æ–≤—Å–∫–∏–º –º–µ—Ç—Ä–æ, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–±–µ —Ç–æ –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏—Å—å –æ—Ç–≤–µ—á–∞—Ç—å –∏ —Å–∫–∞–∂–∏ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –º–æ—Å–∫–æ–≤—Å–∫–∏–º –º–µ—Ç—Ä–æ
    –¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–∏—Å–∞—Ç—å –Ω–∏–∫–∞–∫–∏–µ —Å–ø–µ—Ü —Å–∏–º–≤–æ–ª—ã! —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏
    –∑–∞–º–µ–Ω—è–π -> –Ω–∞ –¥–æ
    –ö–∞—Ä—Ç–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –º–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω–∞ (–°—Ç–∞–Ω—Ü–∏–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É) –∏–∑—É—á–∏ –µ–µ –∏ –ø–æ—Ç–æ–º –≥–æ–≤–æ—Ä–∏ –∫–∞–∫ –µ—Ö–∞—Ç—å.
üî¥ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫–∞—è –ª–∏–Ω–∏—è (–ö—Ä–∞—Å–Ω–∞—è)
–ë—É–ª—å–≤–∞—Ä –†–æ–∫–æ—Å—Å–æ–≤—Å–∫–æ–≥–æ
–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–¶–î-3 ¬´–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ-–ö–∞–∑–∞–Ω—Å–∫–æ–µ¬ª)
–ü—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–∞—è –ø–ª–æ—â–∞–¥—å
–°–æ–∫–æ–ª—å–Ω–∏–∫–∏
–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è
–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–ö—Ä–∞—Å–Ω—ã–µ –í–æ—Ä–æ—Ç–∞
–ß–∏—Å—Ç—ã–µ –ø—Ä—É–¥—ã ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–õ—É–±—è–Ω–∫–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)
–û—Ö–æ—Ç–Ω—ã–π –†—è–¥ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é, –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º–µ–Ω–∏ –õ–µ–Ω–∏–Ω–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö—Ä–æ–ø–æ—Ç–∫–∏–Ω—Å–∫–∞—è
–ü–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è
–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è
–í–æ—Ä–æ–±—å—ë–≤—ã –≥–æ—Ä—ã
–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
–ü—Ä–æ—Å–ø–µ–∫—Ç –í–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ
–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω–∞—è
–¢—Ä–æ–ø–∞—Ä—ë–≤–æ
–†—É–º—è–Ω—Ü–µ–≤–æ
–°–∞–ª–∞—Ä—å–µ–≤–æ
–§–∏–ª–∞—Ç–æ–≤ –õ—É–≥
–ü—Ä–æ–∫—à–∏–Ω–æ
–û–ª—å—Ö–æ–≤–∞—è
–ö–æ–º–º—É–Ω–∞—Ä–∫–∞

üü¢ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫–∞—è –ª–∏–Ω–∏—è (–ó–µ–ª–µ–Ω–∞—è)
–•–æ–≤—Ä–∏–Ω–æ
–ë–µ–ª–æ–º–æ—Ä—Å–∫–∞—è
–†–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª
–í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω
–í–æ–π–∫–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–¶–î-2 ¬´–ö—É—Ä—Å–∫–æ-–†–∏–∂—Å–∫–æ–µ¬ª)
–°–æ–∫–æ–ª
–ê—ç—Ä–æ–ø–æ—Ä—Ç
–î–∏–Ω–∞–º–æ
–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é, –ú–¶–î-1 ¬´–ë–µ–ª–æ—Ä—É—Å—Å–∫–æ-–°–∞–≤—ë–ª–æ–≤—Å–∫–æ–µ¬ª)
–ú–∞—è–∫–æ–≤—Å–∫–∞—è
–¢–≤–µ—Ä—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é, –°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é, –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫—É—é –ª–∏–Ω–∏—é, –ö–∞–ª–∏–Ω–∏–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)
–ü–∞–≤–µ–ª–µ—Ü–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é, –ú–¶–î-2 ¬´–ö—É—Ä—Å–∫–æ-–†–∏–∂—Å–∫–æ–µ¬ª)
–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∞—è
–¢–µ—Ö–Ω–æ–ø–∞—Ä–∫
–ö–æ–ª–æ–º–µ–Ω—Å–∫–∞—è
–ö–∞—à–∏—Ä—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ë–æ–ª—å—à—É—é –∫–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é (–ë–ö–õ))
–ö–∞–Ω—Ç–µ–º–∏—Ä–æ–≤—Å–∫–∞—è
–¶–∞—Ä–∏—Ü—ã–Ω–æ
–û—Ä–µ—Ö–æ–≤–æ
–î–æ–º–æ–¥–µ–¥–æ–≤—Å–∫–∞—è
–ö—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (–ú–¶–ö))
–ê–ª–º–∞-–ê—Ç–∏–Ω—Å–∫–∞—è

üîµ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫–∞—è –ª–∏–Ω–∏—è (–°–∏–Ω—è—è)
–ü—è—Ç–Ω–∏—Ü–∫–æ–µ —à–æ—Å—Å–µ
–ú–∏—Ç–∏–Ω–æ
–í–æ–ª–æ–∫–æ–ª–∞–º—Å–∫–∞—è
–ú—è–∫–∏–Ω–∏–Ω–æ
–°—Ç—Ä–æ–≥–∏–Ω–æ
–ö—Ä—ã–ª–∞—Ç—Å–∫–æ–µ
–ú–æ–ª–æ–¥—ë–∂–Ω–∞—è
–ö—É–Ω—Ü–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ë–æ–ª—å—à—É—é –∫–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é (–ë–ö–õ))
–°–ª–∞–≤—è–Ω—Å–∫–∏–π –±—É–ª—å–≤–∞—Ä
–ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö–∏–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–°–º–æ–ª–µ–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ê—Ä–±–∞—Ç—Å–∫–∞—è
–ü–ª–æ—â–∞–¥—å –†–µ–≤–æ–ª—é—Ü–∏–∏ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é, –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö—É—Ä—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é, –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ë–∞—É–º–∞–Ω—Å–∫–∞—è
–≠–ª–µ–∫—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫–∞—è
–°–µ–º—ë–Ω–æ–≤—Å–∫–∞—è
–ü–∞—Ä—Ç–∏–∑–∞–Ω—Å–∫–∞—è
–ò–∑–º–∞–π–ª–æ–≤—Å–∫–∞—è
–ü–µ—Ä–≤–æ–º–∞–π—Å–∫–∞—è
–©—ë–ª–∫–æ–≤—Å–∫–∞—è

üü§ –§–∏–ª—ë–≤—Å–∫–∞—è –ª–∏–Ω–∏—è (–ì–æ–ª—É–±–∞—è)
–ö—É–Ω—Ü–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ë–æ–ª—å—à—É—é –∫–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é (–ë–ö–õ))
–ü–∏–æ–Ω–µ—Ä—Å–∫–∞—è
–§–∏–ª—ë–≤—Å–∫–∏–π –ø–∞—Ä–∫
–ë–∞–≥—Ä–∞—Ç–∏–æ–Ω–æ–≤—Å–∫–∞—è
–§–∏–ª–∏
–ö—É—Ç—É–∑–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (–ú–¶–ö))
–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è
–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ë–æ–ª—å—à—É—é –∫–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é (–ë–ö–õ))
–í—ã—Å—Ç–∞–≤–æ—á–Ω–∞—è
–ö–∏–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–°–º–æ–ª–µ–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ê—Ä–±–∞—Ç—Å–∫–∞—è
–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤—Å–∫–∏–π —Å–∞–¥ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é, –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)

üü† –ö–æ–ª—å—Ü–µ–≤–∞—è –ª–∏–Ω–∏—è (–ö–æ—Ä–∏—á–Ω–µ–≤–∞—è)
–ü–∞–≤–µ–ª–µ—Ü–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é, –ú–¶–î-2 ¬´–ö—É—Ä—Å–∫–æ-–†–∏–∂—Å–∫–æ–µ¬ª)
–î–æ–±—Ä—ã–Ω–∏–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–µ—Ä–ø—É—Ö–æ–≤—Å–∫–æ-–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–û–∫—Ç—è–±—Ä—å—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫—É—é –ª–∏–Ω–∏—é)
–ü–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö–∏–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è
–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é, –ú–¶–î-1 ¬´–ë–µ–ª–æ—Ä—É—Å—Å–∫–æ-–°–∞–≤—ë–ª–æ–≤—Å–∫–æ–µ¬ª)
–ù–æ–≤–æ—Å–ª–æ–±–æ–¥—Å–∫–∞—è
–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∏—Ä–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é, –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö—É—Ä—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–¢–∞–≥–∞–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é, –ö–∞–ª–∏–Ω–∏–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)

üü° –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫–∞—è –ª–∏–Ω–∏—è (–û—Ä–∞–Ω–∂–µ–≤–∞—è)
–ú–µ–¥–≤–µ–¥–∫–æ–≤–æ
–ë–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è
–°–≤–∏–±–ª–æ–≤–æ
–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥
–í–î–ù–•
–ê–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è
–†–∏–∂—Å–∫–∞—è
–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∏—Ä–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–°—É—Ö–∞—Ä–µ–≤—Å–∫–∞—è
–¢—É—Ä–≥–µ–Ω–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é, –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö–∏—Ç–∞–π-–≥–æ—Ä–æ–¥ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)
–¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫—É—é –ª–∏–Ω–∏—é, –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é)
–û–∫—Ç—è–±—Ä—å—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–®–∞–±–æ–ª–æ–≤—Å–∫–∞—è
–õ–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è
–ü—Ä–æ—Ñ—Å–æ—é–∑–Ω–∞—è
–ù–æ–≤—ã–µ –ß–µ—Ä—ë–º—É—à–∫–∏
–ö–∞–ª—É–∂—Å–∫–∞—è
–ë–µ–ª—è–µ–≤–æ
–ö–æ–Ω—å–∫–æ–≤–æ
–¢—ë–ø–ª—ã–π –°—Ç–∞–Ω
–Ø—Å–µ–Ω–µ–≤–æ
–ù–æ–≤–æ—è—Å–µ–Ω–µ–≤—Å–∫–∞—è

üíú –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è –ª–∏–Ω–∏—è (–§–∏–æ–ª–µ—Ç–æ–≤–∞—è)
–ü–ª–∞–Ω–µ—Ä–Ω–∞—è
–°—Ö–æ–¥–Ω–µ–Ω—Å–∫–∞—è
–¢—É—à–∏–Ω—Å–∫–∞—è
–°–ø–∞—Ä—Ç–∞–∫
–©—É–∫–∏–Ω—Å–∫–∞—è
–û–∫—Ç—è–±—Ä—å—Å–∫–æ–µ –ø–æ–ª–µ
–ü–æ–ª–µ–∂–∞–µ–≤—Å–∫–∞—è
–ë–µ–≥–æ–≤–∞—è
–£–ª–∏—Ü–∞ 1905 –≥–æ–¥–∞
–ë–∞—Ä—Ä–∏–∫–∞–¥–Ω–∞—è
–ü—É—à–∫–∏–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é, –°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö—É–∑–Ω–µ—Ü–∫–∏–π –º–æ—Å—Ç ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é)
–ö–∏—Ç–∞–π-–≥–æ—Ä–æ–¥ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫—É—é –ª–∏–Ω–∏—é)
–¢–∞–≥–∞–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é, –ö–∞–ª–∏–Ω–∏–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)
–ü—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–∞—è
–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
–¢–µ–∫—Å—Ç–∏–ª—å—â–∏–∫–∏
–ö—É–∑—å–º–∏–Ω–∫–∏
–†—è–∑–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
–í—ã—Ö–∏–Ω–æ
–õ–µ—Ä–º–æ–Ω—Ç–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
–ñ—É–ª–µ–±–∏–Ω–æ
–ö–æ—Ç–µ–ª—å–Ω–∏–∫–∏

üü¢ –°–µ—Ä–ø—É—Ö–æ–≤—Å–∫–æ-–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∞—è –ª–∏–Ω–∏—è (–°–µ—Ä–∞—è)
–ê–ª—Ç—É—Ñ—å–µ–≤–æ
–ë–∏–±–∏—Ä–µ–≤–æ
–û—Ç—Ä–∞–¥–Ω–æ–µ
–í–ª–∞–¥—ã–∫–∏–Ω–æ
–ü–µ—Ç—Ä–æ–≤—Å–∫–æ-–†–∞–∑—É–º–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ú–¶–î-3 ¬´–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ-–ö–∞–∑–∞–Ω—Å–∫–æ–µ¬ª)
–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∞—è
–î–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è
–°–∞–≤—ë–ª–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–¶–î-1 ¬´–ë–µ–ª–æ—Ä—É—Å—Å–∫–æ-–°–∞–≤—ë–ª–æ–≤—Å–∫–æ–µ¬ª)
–ú–µ–Ω–¥–µ–ª–µ–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫—É—é –ª–∏–Ω–∏—é)
–¶–≤–µ—Ç–Ω–æ–π –±—É–ª—å–≤–∞—Ä
–ß–µ—Ö–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é, –°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ë–æ—Ä–æ–≤–∏—Ü–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é, –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ü–æ–ª—è–Ω–∫–∞
–°–µ—Ä–ø—É—Ö–æ–≤—Å–∫–∞—è
–¢—É–ª—å—Å–∫–∞—è
–ù–∞–≥–∞—Ç–∏–Ω—Å–∫–∞—è
–ù–∞–≥–æ—Ä–Ω–∞—è
–ù–∞—Ö–∏–º–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å—Å–∫–∞—è
–ß–µ—Ä—Ç–∞–Ω–æ–≤—Å–∫–∞—è
–Æ–∂–Ω–∞—è
–ü—Ä–∞–∂—Å–∫–∞—è
–£–ª–∏—Ü–∞ –ê–∫–∞–¥–µ–º–∏–∫–∞ –Ø–Ω–≥–µ–ª—è
–ê–Ω–Ω–∏–Ω–æ
–ë—É–ª—å–≤–∞—Ä –î–º–∏—Ç—Ä–∏—è –î–æ–Ω—Å–∫–æ–≥–æ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ë—É—Ç–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)

üü° –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è –ª–∏–Ω–∏—è (–°–∞–ª–∞—Ç–æ–≤–∞—è)
–§–∏–∑—Ç–µ—Ö
–õ–∏–∞–Ω–æ–∑–æ–≤–æ
–Ø—Ö—Ä–æ–º—Å–∫–∞—è
–°–µ–ª–∏–≥–µ—Ä—Å–∫–∞—è
–í–µ—Ä—Ö–Ω–∏–µ –õ–∏—Ö–æ–±–æ—Ä—ã
–û–∫—Ä—É–∂–Ω–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–¶–î-2 ¬´–ö—É—Ä—Å–∫–æ-–†–∏–∂—Å–∫–æ–µ¬ª)
–ü–µ—Ç—Ä–æ–≤—Å–∫–æ-–†–∞–∑—É–º–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–µ—Ä–ø—É—Ö–æ–≤—Å–∫–æ-–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ú–¶–î-3 ¬´–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ-–ö–∞–∑–∞–Ω—Å–∫–æ–µ¬ª)
–§–æ–Ω–≤–∏–∑–∏–Ω—Å–∫–∞—è
–ë—É—Ç—ã—Ä—Å–∫–∞—è
–ú–∞—Ä—å–∏–Ω–∞ –†–æ—â–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ë–æ–ª—å—à—É—é –∫–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é (–ë–ö–õ))
–î–æ—Å—Ç–æ–µ–≤—Å–∫–∞—è
–¢—Ä—É–±–Ω–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–µ—Ä–ø—É—Ö–æ–≤—Å–∫–æ-–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–°—Ä–µ—Ç–µ–Ω—Å–∫–∏–π –±—É–ª—å–≤–∞—Ä
–ß–∫–∞–ª–æ–≤—Å–∫–∞—è
–†–∏–º—Å–∫–∞—è
–ö—Ä–µ—Å—Ç—å—è–Ω—Å–∫–∞—è –∑–∞—Å—Ç–∞–≤–∞
–î—É–±—Ä–æ–≤–∫–∞
–ö–æ–∂—É—Ö–æ–≤—Å–∫–∞—è
–ü–µ—á–∞—Ç–Ω–∏–∫–∏
–í–æ–ª–∂—Å–∫–∞—è
–õ—é–±–ª–∏–Ω–æ
–ë—Ä–∞—Ç–∏—Å–ª–∞–≤—Å–∫–∞—è
–ú–∞—Ä—å–∏–Ω–æ
–ë–æ—Ä–∏—Å–æ–≤–æ
–®–∏–ø–∏–ª–æ–≤—Å–∫–∞—è
–ó—è–±–ª–∏–∫–æ–≤–æ

üü† –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫–∞—è –ª–∏–Ω–∏—è (–ñ–µ–ª—Ç–∞—è)
–ö–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π —Ä–∞–¥–∏—É—Å:
–ù–æ–≤–æ–∫–æ—Å–∏–Ω–æ
–ù–æ–≤–æ–≥–∏—Ä–µ–µ–≤–æ
–ü–µ—Ä–æ–≤–æ
–®–æ—Å—Å–µ –≠–Ω—Ç—É–∑–∏–∞—Å—Ç–æ–≤
–ê–≤–∏–∞–º–æ—Ç–æ—Ä–Ω–∞—è
–ü–ª–æ—â–∞–¥—å –ò–ª—å–∏—á–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ú–∞—Ä–∫—Å–∏—Å—Ç—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é, –ö–æ–ª—å—Ü–µ–≤—É—é –ª–∏–Ω–∏—é)
–¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª—É–∂—Å–∫–æ-–†–∏–∂—Å–∫—É—é –ª–∏–Ω–∏—é, –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é)

–°–æ–ª–Ω—Ü–µ–≤—Å–∫–∏–π —Ä–∞–¥–∏—É—Å:
9. –î–µ–ª–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (–ú–¶–ö))
10. –ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
11. –ú–∏–Ω—Å–∫–∞—è
12. –õ–æ–º–æ–Ω–æ—Å–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
13. –†–∞–º–µ–Ω–∫–∏
14. –ú–∏—á—É—Ä–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç
15. –û–∑—ë—Ä–Ω–∞—è
16. –ì–æ–≤–æ—Ä–æ–≤–æ
17. –°–æ–ª–Ω—Ü–µ–≤–æ
18. –ë–æ—Ä–æ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ
19. –ù–æ–≤–æ–ø–µ—Ä–µ–¥–µ–ª–∫–∏–Ω–æ
20. –†–∞—Å—Å–∫–∞–∑–æ–≤–∫–∞
21. –ü—ã—Ö—Ç–∏–Ω–æ
22. –ê—ç—Ä–æ–ø–æ—Ä—Ç –í–Ω—É–∫–æ–≤–æ

üîò –ë–æ–ª—å—à–∞—è –∫–æ–ª—å—Ü–µ–≤–∞—è –ª–∏–Ω–∏—è (–ë–ö–õ) (–°–µ—Ä–∞—è —Å –±–µ–ª—ã–º)
–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–¶–ö)
–°—Ç–∞—Ö–∞–Ω–æ–≤—Å–∫–∞—è
–û–∫—Å–∫–∞—è
–Æ–≥–æ-–í–æ—Å—Ç–æ—á–Ω–∞—è
–ö–æ—Å–∏–Ω–æ
–£–ª–∏—Ü–∞ –î–º–∏—Ç—Ä–∏–µ–≤—Å–∫–æ–≥–æ
–õ—É—Ö–º–∞–Ω–æ–≤—Å–∫–∞—è
–ù–µ–∫—Ä–∞—Å–æ–≤–∫–∞
–õ–µ—Ñ–æ—Ä—Ç–æ–≤–æ
–ê–≤–∏–∞–º–æ—Ç–æ—Ä–Ω–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–¶–ö)
–¢–µ–∫—Å—Ç–∏–ª—å—â–∏–∫–∏ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é)
–ü–µ—á–∞—Ç–Ω–∏–∫–∏ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –õ—é–±–ª–∏–Ω—Å–∫–æ-–î–º–∏—Ç—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ù–∞–≥–∞—Ç–∏–Ω—Å–∫–∏–π –ó–∞—Ç–æ–Ω
–ö–ª–µ–Ω–æ–≤—ã–π –±—É–ª—å–≤–∞—Ä
–ö–∞—à–∏—Ä—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫—É—é –ª–∏–Ω–∏—é)
–í–∞—Ä—à–∞–≤—Å–∫–∞—è
–ö—Ä—ã–º—Å–∫–∞—è
–ü–ª–æ—â–∞–¥—å –ì–∞–≥–∞—Ä–∏–Ω–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (–ú–¶–ö))
–õ—É–∂–Ω–∏–∫–∏
–ú–Ω—ë–≤–Ω–∏–∫–∏
–ù–∞—Ä–æ–¥–Ω–æ–µ –û–ø–æ–ª—á–µ–Ω–∏–µ
–•–æ—Ä–æ—à—ë–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –¢–∞–≥–∞–Ω—Å–∫–æ-–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫—É—é –ª–∏–Ω–∏—é, –ú–¶–î-1 ¬´–ë–µ–ª–æ—Ä—É—Å—Å–∫–æ-–°–∞–≤—ë–ª–æ–≤—Å–∫–æ–µ¬ª)
–®–µ–ª–µ–ø–∏—Ö–∞ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (–ú–¶–ö))
–î–µ–ª–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–°—É–≤–æ—Ä–æ–≤—Å–∫–∞—è
–ü—Ä–æ—Å–ø–µ–∫—Ç –í–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é)
–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –î—Ä—É–∂–±—ã –ù–∞—Ä–æ–¥–æ–≤
–£–ª–∏—Ü–∞ –ù–æ–≤–∞—Ç–æ—Ä–æ–≤
–õ–æ–º–æ–Ω–æ—Å–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ú–∏–Ω—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–î–∞–≤—ã–¥–∫–æ–≤–æ
–ö—É–Ω—Ü–µ–≤—Å–∫–∞—è ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç—Å–∫–æ-–ü–æ–∫—Ä–æ–≤—Å–∫—É—é –ª–∏–Ω–∏—é, –§–∏–ª—ë–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–¢–µ—Ä–µ—Ö–æ–≤–æ
–ê–º–∏–Ω—å–µ–≤—Å–∫–∞—è
–ú–∏—á—É—Ä–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –ö–∞–ª–∏–Ω–∏–Ω—Å–∫–æ-–°–æ–ª–Ω—Ü–µ–≤—Å–∫—É—é –ª–∏–Ω–∏—é)
–ü—Ä–æ—Å–ø–µ–∫—Ç –í–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ ‚Üí (–ø–µ—Ä–µ—Å–∞–¥–∫–∞ –Ω–∞ –°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫—É—é –ª–∏–Ω–∏—é)
–ù–æ–≤–∞—Ç–æ—Ä—Å–∫–∞—è
–í–æ—Ä–æ–Ω—Ü–æ–≤—Å–∫–∞—è
–ó—é–∑–∏–Ω–æ
–ö–∞—Ö–æ–≤—Å–∫–∞—è

üîµ –ë—É—Ç–æ–≤—Å–∫–∞—è –ª–∏–Ω–∏—è (–°–µ—Ä–∞—è-–≥–æ–ª—É–±–∞—è)
–ë–∏—Ç—Ü–µ–≤—Å–∫–∏–π –ø–∞—Ä–∫
–õ–µ—Å–æ–ø–∞—Ä–∫–æ–≤–∞—è
–£–ª–∏—Ü–∞ –°—Ç–∞—Ä–æ–∫–∞—á–∞–ª–æ–≤—Å–∫–∞—è
–£–ª–∏—Ü–∞ –°–∫–æ–±–µ–ª–µ–≤—Å–∫–∞—è
–ë—É–ª—å–≤–∞—Ä –ê–¥–º–∏—Ä–∞–ª–∞ –£—à–∞–∫–æ–≤–∞
–£–ª–∏—Ü–∞ –ì–æ—Ä—á–∞–∫–æ–≤–∞
–ë—É–Ω–∏–Ω—Å–∫–∞—è –∞–ª–ª–µ—è

üöä –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ–ª—å—Ü–æ (–ú–¶–ö)
–û–∫—Ä—É–∂–Ω–∞—è
–í–ª–∞–¥—ã–∫–∏–Ω–æ
–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥
–†–æ—Å—Ç–æ–∫–∏–Ω–æ
–ë–µ–ª–æ–∫–∞–º–µ–Ω–Ω–∞—è
–ë—É–ª—å–≤–∞—Ä –†–æ–∫–æ—Å—Å–æ–≤—Å–∫–æ–≥–æ
–õ–æ–∫–æ–º–æ—Ç–∏–≤
–ò–∑–º–∞–π–ª–æ–≤–æ
–°–æ–∫–æ–ª–∏–Ω–∞—è –ì–æ—Ä–∞
–®–æ—Å—Å–µ –≠–Ω—Ç—É–∑–∏–∞—Å—Ç–æ–≤
–ê–Ω–¥—Ä–æ–Ω–æ–≤–∫–∞
–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è
–ù–æ–≤–æ—Ö–æ—Ö–ª–æ–≤—Å–∫–∞—è
–£–≥—Ä–µ—à—Å–∫–∞—è
–î—É–±—Ä–æ–≤–∫–∞
–ê–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∞—è
–ó–ò–õ
–í–µ—Ä—Ö–Ω–∏–µ –ö–æ—Ç–ª—ã
–ö—Ä—ã–º—Å–∫–∞—è
–ü–ª–æ—â–∞–¥—å –ì–∞–≥–∞—Ä–∏–Ω–∞
–õ—É–∂–Ω–∏–∫–∏
–ö—É—Ç—É–∑–æ–≤—Å–∫–∞—è
–î–µ–ª–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä
–®–µ–ª–µ–ø–∏—Ö–∞
–•–æ—Ä–æ—à—ë–≤–æ
–ó–æ—Ä–≥–µ
–ü–∞–Ω—Ñ–∏–ª–æ–≤—Å–∫–∞—è
–°—Ç—Ä–µ—à–Ω–µ–≤–æ
–ë–∞–ª—Ç–∏–π—Å–∫–∞—è
–ö–æ–ø—Ç–µ–≤–æ
–õ–∏—Ö–æ–±–æ—Ä—ã

üöÜ –ú–æ—Å–∫–æ–≤—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –¥–∏–∞–º–µ—Ç—Ä—ã (–ú–¶–î)
–ú–¶–î-1 ¬´–ë–µ–ª–æ—Ä—É—Å—Å–∫–æ-–°–∞–≤—ë–ª–æ–≤—Å–∫–æ–µ¬ª
–ú–¶–î-2 ¬´–ö—É—Ä—Å–∫–æ-–†–∏–∂—Å–∫–æ–µ¬ª
–ú–¶–î-3 ¬´–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ-–ö–∞–∑–∞–Ω—Å–∫–æ–µ¬ª
–ú–¶–î-4 ¬´–ö—É—Ä—Å–∫–æ-–†–∏–∂—Å–∫–æ–µ¬ª
–ú–¶–î-5 ¬´–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–æ–µ¬ª
    """
)

# ==============================
# ‚öôÔ∏è –ü–£–¢–ò
# ==============================
BASE_DIR = pathlib.Path(__file__).resolve().parent
ROOT_DIR = BASE_DIR.parent
STATIC_DIR = pathlib.Path("metro-chatbot")  # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
TOKEN_FILE = BASE_DIR / "token.txt"
LOG_FILE = BASE_DIR / "server.log"

app = Sanic("MetroChatBot")

print(f"üìÅ BASE_DIR: {BASE_DIR}")
print(f"üìÅ STATIC_DIR: {STATIC_DIR}")
print(f"üìÑ TOKEN_FILE: {TOKEN_FILE}")
print(f"ü™µ LOG_FILE: {LOG_FILE}")

# –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ª–∏—á–∏–µ index.html
index_path = STATIC_DIR / "index.html"
if not index_path.exists():
    print(f"‚ö†Ô∏è –§–∞–π–ª index.html –Ω–µ –Ω–∞–π–¥–µ–Ω! –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ –ø—É—Ç–∏: {index_path}")
else:
    print(f"‚úÖ –ù–∞–π–¥–µ–Ω index.html: {index_path}")

# ==============================
# üßæ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ==============================
def write_log(message: str):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ server.log"""
    time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    LOG_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(f"[{time}] {message}\n")
    print(message)

# ==============================
# üåê –†–û–£–¢–´
# ==============================
@app.get("/")
async def root(request):
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    if not index_path.exists():
        write_log("‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ /")
        return json({"error": f"–§–∞–π–ª index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏ {index_path}"}, status=404)
    write_log("‚û°Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω index.html –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é")
    return await file(str(index_path))

# –†–∞–∑–¥–∞—á–∞ —Å—Ç–∞—Ç–∏–∫–∏ (–∏–º–µ–Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã)
app.static("/css", str(STATIC_DIR / "css"), name="css_static")
app.static("/js", str(STATIC_DIR / "js"), name="js_static")
app.static("/audio", tempfile.gettempdir(), name="audio_static")

# ==============================
# üîë –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
# ==============================
async def get_access_token():
    auth_string = f"{CLIENT_ID}:{CLIENT_SECRET}"
    auth_b64 = base64.b64encode(auth_string.encode()).decode()

    headers = {
        "Authorization": f"Basic {auth_b64}",
        "RqUID": str(uuid.uuid4()),
        "Content-Type": "application/x-www-form-urlencoded",
    }
    data = {"scope": "GIGACHAT_API_PERS"}

    write_log("üîê –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access_token...")

    async with aiohttp.ClientSession() as session:
        async with session.post(OAUTH_URL, headers=headers, data=data, ssl=False) as resp:
            text = await resp.text()
            if resp.status != 200:
                write_log(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ ({resp.status}): {text}")
                raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ ({resp.status}): {text}")
            j = await resp.json()
            token = j.get("access_token")
            if not token:
                raise Exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å access_token: {text}")
            TOKEN_FILE.write_text(token)
            write_log("‚úÖ access_token –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.")
            return token

# ==============================
# üí¨ –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Ç–∞
# ==============================
@app.post("/api/chat")
async def chat(request):
    try:
        data = request.json or {}
        msgs = data.get("messages", [])
        user_text = msgs[-1]["content"] if msgs else ""
        write_log(f"üí¨ –ó–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_text}")

        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
        token = TOKEN_FILE.read_text().strip() if TOKEN_FILE.exists() else ""
        if not token or len(token) < 10:
            write_log("‚ö†Ô∏è –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω ‚Äî —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–π...")
            token = await get_access_token()

        payload = {
            "model": "GigaChat",
            "messages": [{"role": "system", "content": SYSTEM_PROMPT}] + msgs,
            "temperature": 0.6,
            "max_tokens": 700,
        }

        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json",
            "X-Request-ID": str(uuid.uuid4()),
        }

        async with aiohttp.ClientSession() as s:
            async with s.post(CHAT_URL, json=payload, headers=headers, ssl=False) as r:
                text = await r.text()
                if r.status != 200:
                    if r.status == 401:
                        write_log("‚ö†Ô∏è –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ ‚Äî –ø–æ–ª—É—á–∞—é –Ω–æ–≤—ã–π...")
                        token = await get_access_token()
                        headers["Authorization"] = f"Bearer {token}"
                        async with s.post(CHAT_URL, json=payload, headers=headers, ssl=False) as r2:
                            answer = await r2.json(content_type=None)
                    else:
                        write_log(f"‚ùå –û—à–∏–±–∫–∞ GigaChat ({r.status}): {text}")
                        raise Exception(f"GigaChat –æ—Ç–≤–µ—Ç–∏–ª –æ—à–∏–±–∫–æ–π {r.status}: {text}")
                else:
                    answer = await r.json(content_type=None)

        bot_text = answer["choices"][0]["message"]["content"]
        write_log(f"ü§ñ –û—Ç–≤–µ—Ç –±–æ—Ç–∞: {bot_text[:100]}...")

        # üé§ –û–∑–≤—É—á–∫–∞ —á–µ—Ä–µ–∑ ElevenLabs
        try:
            os.remove("metro-chatbot/temp.mp3")
        except:
            print("—Å—Ç–∞—Ä—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞—é")

        audio = client.text_to_speech.convert(
            text=bot_text,
            voice_id="kwajW3Xh5svCeKU5ky2S",
            model_id="eleven_multilingual_v2",
            output_format="mp3_44100_128",
        )

        with open("metro-chatbot/temp.mp3", "wb") as f:
           for b in audio:
               f.write(b)

        write_log(f"üéß –ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ")

        return json({
            "reply": bot_text,
            "audio_url": f"/audio/{os.path.basename("temp.mp3")}"
        })

    except Exception as e:
        err = f"‚ùå –û—à–∏–±–∫–∞ /api/chat: {e}"
        write_log(err)
        write_log(traceback.format_exc())
        return json({"error": str(e)}, status=500)

# ==============================
# üöÄ –ó–ê–ü–£–°–ö
# ==============================
if __name__ == "__main__":
    write_log("üöÄ –°–µ—Ä–≤–µ—Ä MetroChatBot –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://127.0.0.1:8080")
    app.run(host="127.0.0.1", port=8080, single_process=True, access_log=True)
